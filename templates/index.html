<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸµ Music Mood Predictor</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ range(1, 9999) | random }}">
</head>
<body>
  <div class="container">
    <div class="header-section">
      <h1>ğŸ¶ Music Mood Predictor</h1>
      <p class="tagline">Enter your song lyrics and let AI feel the vibe ğŸ§</p>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="totalPredictions">0</div>
        <div class="stat-label">Predictions</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="wordCount">0</div>
        <div class="stat-label">Words</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="charCount">0</div>
        <div class="stat-label">Characters</div>
      </div>
    </div>

    <form id="lyricsForm">
      <div class="form-group">
        <textarea 
          id="lyricsInput" 
          placeholder="Type or paste your song lyrics here... ğŸµ" 
          spellcheck="true"
          required
        ></textarea>
        <div class="char-counter" id="charCounter">0 / 5000</div>
      </div>

      <div class="button-row">
        <button id="predictBtn" type="submit" class="btn-primary">ğŸ”® Predict Mood</button>
        <button type="button" id="clearBtn" class="btn-secondary">ğŸ—‘ï¸ Clear</button>
        <button type="button" id="demoBtn" class="btn-secondary">âœ¨ Demo Lyrics</button>
        <button type="button" id="historyToggle" class="btn-secondary">ğŸ“œ History</button>
      </div>
    </form>

    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <p>Analyzing lyrics...</p>
    </div>

    <div id="result" class="result" style="display: none;">
      <h2>Predicted Mood ğŸ§</h2>
      <div class="mood-emoji" id="moodEmoji">ğŸµ</div>
      <p class="mood-text" id="moodText">Happy</p>
      <p class="mood-desc" id="moodDesc">ğŸŒ A bright and upbeat vibe â€” your song radiates positivity!</p>
      
      <div class="confidence-bar">
        <div class="confidence-label">
          <span>Confidence</span>
          <span id="confidenceValue">95%</span>
        </div>
        <div class="confidence-track">
          <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="action-buttons">
        <button type="button" id="saveBtn" class="btn-save">ğŸ’¾ Save Prediction</button>
        <button type="button" id="shareBtn" class="btn-share">ğŸ“¤ Share</button>
        <button type="button" id="analyzeAgain" class="btn-history">ğŸ”„ Analyze Again</button>
      </div>
    </div>

    <div id="historyPanel" class="history-panel" style="display: none;">
      <h3>ğŸ“œ Recent Predictions</h3>
      <div id="historyList"></div>
      <button type="button" id="clearHistory" class="btn-secondary clear-history">Clear History</button>
    </div>

    <div id="errorBox" class="error-box" style="display: none;">
      <p id="errorMessage">âš ï¸ Something went wrong!</p>
    </div>
  </div>

  <footer>Made with ğŸ’œ by <a href="#" id="authorLink">Krina</a></footer>

  <script>
    const lyricsInput = document.getElementById("lyricsInput");
    const form = document.getElementById("lyricsForm");
    const loading = document.getElementById("loading");
    const resultBox = document.getElementById("result");
    const errorBox = document.getElementById("errorBox");
    const charCounter = document.getElementById("charCounter");
    const wordCountEl = document.getElementById("wordCount");
    const charCountEl = document.getElementById("charCount");
    const totalPredictionsEl = document.getElementById("totalPredictions");
    const historyPanel = document.getElementById("historyPanel");
    const historyList = document.getElementById("historyList");

    const demoLyricsList = [
      "Dancing through the fire, I keep rising higher ğŸ”¥\nEvery beat, every step takes me to the sky\nNothing's gonna stop me now, I'm feeling so alive",
      "Raindrops on my window, but I feel warm inside â˜”\nYour memory wraps around me like a gentle embrace\nEven in the storm, I find my peaceful place",
      "My heart beats louder when I see your face â¤ï¸\nTime stands still, the world fades away\nIn your eyes I found my home, forever I'll stay",
      "The world slows down when the stars light up ğŸŒŒ\nIn the silence of the night, I find my peace\nDreams floating by like clouds, sweet release",
      "Lost in my thoughts, but I find peace in sound ğŸ§\nMelodies carry me to places unknown\nIn the music, I'm never alone",
      "Screaming at the walls, they never answer back\nFire in my veins, I'm ready to attack\nThis rage inside won't fade to black",
      "Shadows follow me wherever I go\nCan't escape this feeling, it cuts so deep\nIn the darkness, my secrets keep"
    ];

    const moodEmojis = {
      happy: "ğŸ˜Š",
      sad: "ğŸ˜¢",
      angry: "ğŸ˜ ",
      relaxed: "ğŸ˜Œ",
      fear: "ğŸ˜°",
      neutral: "ğŸ˜"
    };

    const moodDescriptions = {
      happy: "ğŸŒ A bright and upbeat vibe â€” your song radiates positivity and joy!",
      sad: "ğŸ’” The lyrics carry emotion and depth â€” a heartfelt, melancholic melody.",
      angry: "ğŸ”¥ Intense and passionate energy â€” pure power and raw emotion in every word!",
      relaxed: "ğŸŒ™ Smooth and soothing â€” perfect for chill vibes and peaceful moments.",
      fear: "ğŸ˜° Anxious and tense emotions â€” vulnerability expressed through powerful words.",
      neutral: "ğŸ¶ A balanced emotional blend â€” subtle and contemplative."
    };

    let predictionHistory = JSON.parse(localStorage.getItem('moodHistory')) || [];
    updateTotalPredictions();

    // Character and word counter
    lyricsInput.addEventListener("input", () => {
      const text = lyricsInput.value;
      const charCount = text.length;
      const wordCount = text.trim().split(/\s+/).filter(w => w).length;
      
      charCounter.textContent = `${charCount} / 5000`;
      charCountEl.textContent = charCount;
      wordCountEl.textContent = wordCount;

      if (charCount > 5000) {
        charCounter.style.background = "rgba(239, 35, 60, 0.8)";
      } else {
        charCounter.style.background = "rgba(123, 44, 191, 0.8)";
      }

      hideResult();
    });

    // Form submission
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      
      const lyrics = lyricsInput.value.trim();
      if (!lyrics) {
        showError("Please enter some lyrics first!");
        return;
      }

      if (lyrics.length > 5000) {
        showError("Lyrics are too long! Maximum 5000 characters.");
        return;
      }

      showLoading();
      hideResult();
      hideError();

      // Simulate API call with realistic delay
      setTimeout(() => {
        const mood = predictMood(lyrics);
        const confidence = Math.floor(Math.random() * 20) + 80; // 80-100%
        showResult(mood, confidence, lyrics);
        hideLoading();
        saveToHistory(mood, lyrics);
      }, 1500);
    });

    // Simple mood prediction (mock)
    function predictMood(lyrics) {
      const lower = lyrics.toLowerCase();
      
      if (lower.match(/happy|joy|love|smile|bright|sun|dance|celebration|exciting/i)) return "happy";
      if (lower.match(/sad|cry|tear|alone|miss|lost|broken|hurt|pain/i)) return "sad";
      if (lower.match(/angry|rage|hate|fight|scream|fury|mad|fire/i)) return "angry";
      if (lower.match(/calm|peace|relax|chill|smooth|gentle|soft|quiet/i)) return "relaxed";
      if (lower.match(/fear|afraid|scared|worry|anxious|dark|shadow|nightmare/i)) return "fear";
      
      return "neutral";
    }

    function showResult(mood, confidence, lyrics) {
      const moodText = document.getElementById("moodText");
      const moodDesc = document.getElementById("moodDesc");
      const moodEmoji = document.getElementById("moodEmoji");
      const confidenceValue = document.getElementById("confidenceValue");
      const confidenceFill = document.getElementById("confidenceFill");

      moodText.textContent = mood.charAt(0).toUpperCase() + mood.slice(1);
      moodDesc.textContent = moodDescriptions[mood] || moodDescriptions.neutral;
      moodEmoji.textContent = moodEmojis[mood] || "ğŸµ";
      confidenceValue.textContent = `${confidence}%`;
      
      resultBox.style.display = "block";
      setTimeout(() => {
        confidenceFill.style.width = `${confidence}%`;
      }, 100);

      setTimeout(() => {
        resultBox.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 300);
    }

    function hideResult() {
      resultBox.style.display = "none";
      document.getElementById("confidenceFill").style.width = "0%";
    }

    function showLoading() {
      loading.classList.remove("hidden");
    }

    function hideLoading() {
      loading.classList.add("hidden");
    }

    function showError(message) {
      document.getElementById("errorMessage").textContent = "âš ï¸ " + message;
      errorBox.style.display = "block";
      setTimeout(() => {
        errorBox.style.display = "none";
      }, 4000);
    }

    function hideError() {
      errorBox.style.display = "none";
    }

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Clear button
    document.getElementById("clearBtn").addEventListener("click", () => {
      lyricsInput.value = "";
      charCounter.textContent = "0 / 5000";
      charCountEl.textContent = "0";
      wordCountEl.textContent = "0";
      hideResult();
      hideError();
      lyricsInput.focus();
    });

    // Demo button
    document.getElementById("demoBtn").addEventListener("click", () => {
      const random = Math.floor(Math.random() * demoLyricsList.length);
      lyricsInput.value = demoLyricsList[random];
      lyricsInput.dispatchEvent(new Event('input'));
      lyricsInput.focus();
      showToast("Demo lyrics loaded! âœ¨");
    });

    // Save button
    document.getElementById("saveBtn").addEventListener("click", () => {
      const mood = document.getElementById("moodText").textContent;
      const lyrics = lyricsInput.value;
      const confidence = document.getElementById("confidenceValue").textContent;
      
      const content = `Music Mood Prediction
${"=".repeat(50)}

Lyrics:
${lyrics}

Predicted Mood: ${mood}
Confidence: ${confidence}
Date: ${new Date().toLocaleString()}

${"=".repeat(50)}
Generated by Music Mood Predictor ğŸµ`;

      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `mood_prediction_${mood.toLowerCase()}_${Date.now()}.txt`;
      link.click();
      showToast("Prediction saved! ğŸ’¾");
    });

    // Share button
    document.getElementById("shareBtn").addEventListener("click", async () => {
      const mood = document.getElementById("moodText").textContent;
      const text = `I just analyzed my song lyrics! The mood is: ${mood} ğŸµ\n\nTry it yourself with Music Mood Predictor!`;
      
      if (navigator.share) {
        try {
          await navigator.share({ text });
          showToast("Shared successfully! ğŸ“¤");
        } catch (err) {
          copyToClipboard(text);
        }
      } else {
        copyToClipboard(text);
      }
    });

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast("Copied to clipboard! ğŸ“‹");
      }).catch(() => {
        showToast("Could not copy to clipboard");
      });
    }

    // Analyze again button
    document.getElementById("analyzeAgain").addEventListener("click", () => {
      lyricsInput.value = "";
      hideResult();
      lyricsInput.focus();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // History functionality
    function saveToHistory(mood, lyrics) {
      const entry = {
        mood,
        lyrics: lyrics.substring(0, 100) + (lyrics.length > 100 ? "..." : ""),
        timestamp: new Date().toISOString()
      };
      
      predictionHistory.unshift(entry);
      if (predictionHistory.length > 10) predictionHistory.pop();
      
      localStorage.setItem('moodHistory', JSON.stringify(predictionHistory));
      updateTotalPredictions();
    }

    function updateTotalPredictions() {
      totalPredictionsEl.textContent = predictionHistory.length;
    }

    function renderHistory() {
      if (predictionHistory.length === 0) {
        historyList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No predictions yet. Start analyzing!</p>';
        return;
      }

      historyList.innerHTML = predictionHistory.map((entry, index) => `
        <div class="history-item" onclick="loadHistoryItem(${index})">
          <div class="history-item-mood">${moodEmojis[entry.mood.toLowerCase()] || "ğŸµ"} ${entry.mood}</div>
          <div class="history-item-lyrics">${entry.lyrics}</div>
          <div class="history-item-time">${new Date(entry.timestamp).toLocaleString()}</div>
        </div>
      `).join('');
    }

    window.loadHistoryItem = function(index) {
      const entry = predictionHistory[index];
      showToast("History item loaded! âœ¨");
      historyPanel.style.display = "none";
    };

    document.getElementById("historyToggle").addEventListener("click", () => {
      if (historyPanel.style.display === "none") {
        renderHistory();
        historyPanel.style.display = "block";
        historyPanel.scrollIntoView({ behavior: "smooth", block: "nearest" });
      } else {
        historyPanel.style.display = "none";
      }
    });

    document.getElementById("clearHistory").addEventListener("click", () => {
      if (confirm("Are you sure you want to clear all history?")) {
        predictionHistory = [];
        localStorage.removeItem('moodHistory');
        updateTotalPredictions();
        renderHistory();
        showToast("History cleared! ğŸ—‘ï¸");
      }
    });

    // Enter to submit (Shift+Enter for new line)
    lyricsInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });

    // Keyboard navigation
    const focusableElements = [lyricsInput, ...document.querySelectorAll("button")];
    let currentFocusIndex = 0;

    document.addEventListener("keydown", (e) => {
      if (e.target.tagName === "TEXTAREA" && !e.altKey) return;

      if (e.key === "Tab") {
        e.preventDefault();
        currentFocusIndex = (currentFocusIndex + (e.shiftKey ? -1 : 1) + focusableElements.length) % focusableElements.length;
        focusableElements[currentFocusIndex].focus();
      }
    });

    focusableElements.forEach((el, idx) => {
      el.addEventListener("focus", () => {
        currentFocusIndex = idx;
      });
    });

    // Easter egg on author link
    let clickCount = 0;
    document.getElementById("authorLink").addEventListener("click", (e) => {
      e.preventDefault();
      clickCount++;
      if (clickCount === 3) {
        showToast("Thanks for using Music Mood Predictor! ğŸ’œ");
        clickCount = 0;
      }
    });

    // Auto-save draft
    let draftTimeout;
    lyricsInput.addEventListener("input", () => {
      clearTimeout(draftTimeout);
      draftTimeout = setTimeout(() => {
        if (lyricsInput.value.trim()) {
          localStorage.setItem('lyricsDraft', lyricsInput.value);
        }
      }, 1000);
    });

    // Load draft on page load
    window.addEventListener("load", () => {
      const draft = localStorage.getItem('lyricsDraft');
      if (draft) {
        lyricsInput.value = draft;
        lyricsInput.dispatchEvent(new Event('input'));
      }
    });

    // Clear draft after successful prediction
    form.addEventListener("submit", () => {
      localStorage.removeItem('lyricsDraft');
    });

    // Accessibility: Announce results to screen readers
    function announceToScreenReader(message) {
      const announcement = document.createElement("div");
      announcement.setAttribute("role", "status");
      announcement.setAttribute("aria-live", "polite");
      announcement.style.position = "absolute";
      announcement.style.left = "-10000px";
      announcement.textContent = message;
      document.body.appendChild(announcement);
      setTimeout(() => announcement.remove(), 1000);
    }

    // Trigger announcement when result is shown
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.target === resultBox && resultBox.style.display === "block") {
          const mood = document.getElementById("moodText").textContent;
          announceToScreenReader(`Mood prediction complete: ${mood}`);
        }
      });
    });

    observer.observe(resultBox, { attributes: true, attributeFilter: ["style"] });
  </script>
</body>
</html>